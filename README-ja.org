#+TITLE: Emacs OpenSCAD mode with Tree-sitter support
#+AUTHOR: Yoshinari Nomura
#+EMAIL:
#+DATE: 2025-12-28
#+OPTIONS: H:3 num:2 toc:nil
#+OPTIONS: ^:nil \n:nil ::t |:t f:t tex:t
#+OPTIONS: d:nil tags:t
#+OPTIONS: author:t email:nil creator:nil
#+OPTIONS: timestamp:nil timestamps:nil
#+LANGUAGE: ja

#+html: <a href="https://melpa.org/#/scad-ts-mode"><img alt="MELPA" src="https://melpa.org/packages/scad-ts-mode-badge.svg"/></a>

[[file:README.org][English]]

* scad-ts-mode とは
  OpenSCAD のためのメジャーモードです．Tree-sitter による indent と font-locking，
  imenu との連携をサポートしていて，以下の特徴を持っています．

  + c-mode 由来の [[https://github.com/openscad/emacs-scad-mode][scad-mode]] よりも良い indent や syntax-highlight を提供します
  + OpenSCAD GUI の起動 ~(C-c C-c)~ とライフサイクル管理を支援します
  + Linux 環境において
    + [[https://github.com/Lenbok/scad-dbus][scad-dbus]] と連携した GUI 操作において快適な input フォーカスの制御を実現します

* 動作環境
  + Emacs 29.3 or newer (Tree-sitter support)

* インストールとセットアップ
** パッケージのインストール
   scad-ts-modeは [[http://melpa.org/][MELPA]] に収録されています．パッケージングシステムを正しく設定している場合，
   =M-x= =package-install= =scad-ts-mode= でインストールできるでしょう．

   詳しくは [[https://github.com/milkypostman/melpa#usage][MELPA usage]] を参照してください．

** Tree-sitter language grammer のインストール
   ~M-x scad-ts-mode-install-language-grammar~ を実行することで，
   =~/.emacs.d/tree-sitter/libtree-sitter-openscad.so= を準備してくれます．

** パッケージのセットアップ
   init.el の例です．
   #+begin_src emacs-lisp
      (use-package treesit
        :init
        (add-to-list 'auto-mode-alist '("\\.scad\\'" . scad-ts-mode))
        (add-to-list 'major-mode-remap-alist '(scad-mode . scad-ts-mode)))

      (use-package scad-ts-mode
        :ensure t
        ;; :load-path "~/path/to/scad-ts-mode" ;; If install from GitHub
        :after treesit
        :mode "\\.scad\\'"
        :init
        (setq scad-ts-indent-offset 2)
        :config
        ;; Optional
        (add-hook 'scad-ts-mode-hook #'eglot-ensure)
        (add-hook 'scad-ts-mode-hook #'electric-pair-local-mode)
        (add-hook 'scad-ts-mode-hook #'electric-indent-local-mode)
        (add-hook 'scad-ts-mode-hook #'whitespace-mode))
   #+end_src

   もしあなたが Linux ユーザなら，以下の設定をすることで，
   Emacs と GUI の連携がよりよくなるでしょう．xdotool のインストールが必要です．
   #+begin_src emacs-lisp
     (add-hook 'scad-ts-after-open-gui-functions #'scad-ts--gui-focus-control)
   #+end_src

* 他のパッケージとの連携
** scad-dbus
   Linux 環境で D-Bus が使えるのであれば，[[https://github.com/Lenbok/scad-dbus][scad-dbus]] が便利です．
   #+begin_src emacs-lisp
     (use-package scad-dbus
       :after scad-ts-mode
       :load-path "~/path/to/scad-dbus" ;; If install from GitHub
       :config
       (add-hook 'scad-ts-after-open-gui-functions #'scad-ts--gui-focus-control)
       (use-package hydra
         :ensure t))
   #+end_src
   ~scad-ts--gui-focus-control~ は， ~C-c C-c~ による GUI 起動後，Emacs に input focus を戻して
   ~scad-dbus~ の Hydra メニューを表示します．

** Eglot
   Emacs 標準の eglot と openscad-lsp を使うことで，
   flymake, eldoc,  imenu と自動で連携するので，快適に使えます．

   まず，openscad-lsp をインストールしてください．
   #+begin_src shell-script
     cargo install openscad-lsp
   #+end_src

   以下は，Eglot の設定例です．
   #+begin_src emacs-lisp
     (use-package eglot
       :config
       (add-to-list 'eglot-server-programs
                    '(scad-ts-mode . ("openscad-lsp" "--stdio")))
       :bind
       (:map eglot-mode-map
             ("C-c r" . eglot-rename)
             ("C-c h" . eldoc)
             ("C-c f" . flymake-show-buffer-diagnostics)
             ("C-c F" . flymake-show-project-diagnostics)))
   #+end_src

   ~M-TAB~ などによる関数名等の補完も手に入ります．

** Org-babel
   org-babel でのコードブロックの編集，HTMLエクスポート時のシンタックスハイライトを
   ~scad-ts-mode~ に任せたいなら，
   #+begin_src emacs-lisp
     (add-to-list 'org-src-lang-modes '("scad" . scad-ts))
   #+end_src

   [[https://github.com/openscad/emacs-scad-mode/blob/main/ob-scad.el][ob-scad.el]] と共に使うなら，export 設定を以下のようにしておいたほうがよいでしょう (参考: [[https://github.com/openscad/emacs-scad-mode/issues/4][emacs-scad-mode/issues/4]])
   #+begin_src emacs-lisp
     (setq org-babel-default-header-args:scad
       '((:results . "file")
         (:exports . "code")))
   #+end_src

* 開発者情報
** ドキュメント
   参考にしたドキュメントは，以下の通りです．
  + [[https://tree-sitter.github.io/tree-sitter/][Tree-sitter]]
  +  GNU Emacs Lisp Reference Manual
    + [[https://www.gnu.org/software/emacs/manual/html_node/elisp/Parsing-Program-Source.html][Parsing Program Source]]
    + [[https://www.gnu.org/software/emacs/manual/html_node/elisp/Parser_002dbased-Font-Lock.html][Parser-based Font Lock]]
    + [[https://www.gnu.org/software/emacs/manual/html_node/elisp/Parser_002dbased-Indentation.html][Parser-based Indentation]]
      + ~treesit-simple-indent-presets~ 変数
      + ~treesit-simple-indent-rules~ 変数
  + [[https://github.com/emacs-mirror/emacs/blob/master/admin/notes/tree-sitter/starter-guide][STARTER GUIDE ON WRITING MAJOR MODE WITH TREE-SITTER]]

** Tree-sitter 依存コードのデバッグ支援
   + ~M-x treesit-explore-mode~ :: 編集中のコードに対応する tree を表示してくれます．
   + ~(setq treesit--indent-verbose t)~ :: TAB 押下時のインデントで発火したルールを確認できます．
   + ~M-x treesit-check-indent~ :: バッファ内の現在のインデントの状態 vs
     インデントルールが提示するインデントで差分を確認できます．
